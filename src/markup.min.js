var Mark={includes:{},globals:{},delimiter:">",start_delimiter:"{{",end_delimiter:"}}",compact:false,pipeNotFound:function(a){console.warn("pipe not found:",a)},pipeExecutionError:function(b,a){console.error("pipe execution error: "+a+" - "+b)},undefinedResult:function(a){return"???"},_copy:function(d,c){c=c||[];for(var e in d){c[e]=d[e]}return c},_size:function(b){return b instanceof Array?b.length:(b||0)},_iter:function(a,b){this.idx=a;this.size=b;this.length=b;this.sign="#";this.toString=function(){return this.idx+this.sign.length-1}},_pipe:function(h,c){var g,f,b,a;if((g=c.shift())){f=g.split(this.delimiter);b=f.shift().trim();if(typeof(Mark.pipes[b])==="undefined"){this.pipeNotFound(b)}try{a=Mark.pipes[b].apply(null,[h].concat(f));h=this._pipe(a,c)}catch(d){this.pipeExecutionError(d,b)}}return h},_eval:function(b,d,c,e){var k=this._pipe(b,d),h=k,g=-1,f,a;if(!e){if(k instanceof Array){k="";f=h.length;while(++g<f){a={iter:new this._iter(g,f)};k+=c?Mark.up(c,h[g],a):h[g]}}else{if(k instanceof Object){k=Mark.up(c,h)}}}return k},_test:function(a,f,d,c){var b=c.undefinedResult;c.undefinedResult=function(){return""};var e=Mark.up(f,d,c).split(new RegExp(re_escape(this.start_delimiter)+"\\s*else\\s*"+re_escape(this.end_delimiter)));this.undefinedResult=b;return(a===false?e[1]:e[0])||""},_bridge:function(h,e){e=e=="."?"\\.":e.replace(/\$/g,"\\$");var f=this.start_delimiter+"\\s*"+e+"([^/"+re_escape(this.end_delimiter)+"]+\\w*)?"+this.end_delimiter+"|"+this.start_delimiter+"/"+e+"\\s*"+this.end_delimiter,n=new RegExp(f,"g"),p=h.match(n)||[],o,g,m=0,l=0,k=-1,j=0;for(g=0;g<p.length;g++){o=g;k=h.indexOf(p[o],k+1);if(p[o].indexOf(this.start_delimiter+"/")>-1){l++}else{m++}if(m===l){break}}m=h.indexOf(p[0]);l=m+p[0].length;j=k+p[o].length;return[h.substring(m,j),h.substring(l,k)]}};Mark.up=function(w,b,e){b=b||{};e=e||{};if(e.pipes){this._copy(e.pipes,this.pipes)}if(e.includes){this._copy(e.includes,this.includes)}if(e.globals){this._copy(e.globals,this.globals)}if(e.delimiter){this.delimiter=e.delimiter}if(e.start_delimiter){this.start_delimiter=e.start_delimiter}if(e.end_delimiter){this.end_delimiter=e.end_delimiter}if(e.undefinedResult){this.undefinedResult=e.undefinedResult}if(e.pipeNotFound){this.pipeNotFound=e.pipeNotFound}if(e.pipeExecutionError){this.pipeExecutionError=e.pipeExecutionError}if(e.pipeExecutionError){this.pipeExecutionError=e.pipeExecutionError}if(e.compact!==undefined){this.compact=e.compact}var p=new RegExp(re_escape(this.start_delimiter)+"(.+?)"+re_escape(this.end_delimiter),"g"),n=w.match(p)||[],x,d,g,k=[],v,c,q,f,m,s,a,r,o=this,u=0,t=0;while((x=n[u++])){m=undefined;f="";v=x.indexOf("/"+this.end_delimiter)>-1;q=x.indexOf(this.start_delimiter+"!")==0;var l=this.start_delimiter.length+(q?1:0);var h=this.start_delimiter.length+this.end_delimiter.length+(v?1:0)+(q?1:0);d=x.substr(l,x.length-h);d=d.replace(/`(.+?)`/g,function(i,j){return Mark.up(o.start_delimiter+j+o.end_delimiter,b)});c=d.trim().indexOf("if ")===0;k=d.split("|");k.shift();d=d.replace(/^\s*if/,"").split("|").shift().trim();g=c?"if":d.split("|")[0];r=b[d];if(c&&!k.length){k=["notempty"]}if(!v&&w.indexOf(this.start_delimiter+"/"+g)>-1){m=this._bridge(w,g);x=m[0];f=m[1];u+=x.match(p).length-1}if(new RegExp("^"+re_escape(this.start_delimiter)+"\\s*else\\s*"+re_escape(this.end_delimiter)+"$").test(x)){continue}else{if((s=this.globals[d])!==undefined){m=this._eval(s,k,f,q)}else{if((a=this.includes[d])){if(a instanceof Function){a=a()}m=this._pipe(Mark.up(a,b,e),k)}else{if(d.indexOf("#")>-1){e.iter.sign=d;m=this._pipe(e.iter,k)}else{if(d==="."){m=this._pipe(b,k)}else{if(d.indexOf(".")>-1){d=d.split(".");r=Mark.globals[d[0]];if(r){t=1}else{t=0;r=b}while(r&&t<d.length){r=r[d[t++]]}m=this._eval(r,k,f,q)}else{if(c){m=this._pipe(r,k)}else{if(r instanceof Array){m=this._eval(r,k,f,q)}else{if(f){m=r?Mark.up(f,r):undefined}else{if(b.hasOwnProperty(d)){m=this._pipe(r,k)}}}}}}}}}}if(m instanceof Array){m=this._eval(m,k,f,q)}if(c){m=this._test(m,f,b,e)}if(m===undefined){m=this.undefinedResult(d,x,b,f,k,this)}if(q&&x==w){return m}w=w.replace(x,m)}return this.compact?w.replace(/>\s+</g,"><"):w};Mark.pipes={empty:function(a){return !a||(a+"").trim().length===0?a:false},notempty:function(a){return a&&(a+"").trim().length?a:false},blank:function(b,a){return !!b||b===0?b:a},more:function(d,c){return Mark._size(d)>c?d:false},less:function(d,c){return Mark._size(d)<c?d:false},ormore:function(d,c){return Mark._size(d)>=c?d:false},orless:function(d,c){return Mark._size(d)<=c?d:false},between:function(e,d,f){e=Mark._size(e);return e>=d&&e<=f?e:false},equals:function(d,c){return d==c?d:false},notequals:function(d,c){return d!=c?d:false},like:function(b,a){return new RegExp(a,"i").test(b)?b:false},notlike:function(b,a){return !Mark.pipes.like(b,a)?b:false},upcase:function(a){return String(a).toUpperCase()},downcase:function(a){return String(a).toLowerCase()},capcase:function(a){return a.replace(/(?:^|\s)\S/g,function(b){return b.toUpperCase()})},chop:function(a,b){return a.length>b?a.substr(0,b)+"...":a},tease:function(c,d){var b=c.split(/\s+/);return b.slice(0,d).join(" ")+(b.length>d?"...":"")},trim:function(a){return a.trim()},pack:function(a){return a.trim().replace(/\s{2,}/g," ")},round:function(a){return Math.round(+a)},clean:function(a){return String(a).replace(/<\/?[^>]+>/gi,"")},size:function(a){return a.length},length:function(a){return a.length},reverse:function(a){return[].concat(a).reverse()},join:function(a,b){return a.join(b)},limit:function(b,c,a){return b.slice(+a||0,+c+(+a||0))},split:function(b,a){return b.split(a||",")},choose:function(b,c,a){return !!b?c:(a||"")},toggle:function(c,b,a,d){return a.split(",")[b.match(/\w+/g).indexOf(c+"")]||d},sort:function(a,c){var b=function(e,d){return e[c]>d[c]?1:-1};return[].concat(a).sort(c?b:undefined)},fix:function(a,b){return(+a).toFixed(b)},mod:function(a,b){return(+a)%(+b)},divisible:function(a,b){return a&&(+a%b)===0?a:false},even:function(a){return a&&(+a&1)===0?a:false},odd:function(a){return a&&(+a&1)===1?a:false},number:function(a){return parseFloat(a.replace(/[^\-\d\.]/g,""))},url:function(a){return encodeURI(a)},bool:function(a){return !!a},falsy:function(a){return !a},first:function(a){return a.idx===0},last:function(a){return a.idx===a.size-1},call:function(b,a){return b[a].apply(b,[].slice.call(arguments,2))},set:function(b,a){Mark.globals[a]=b;return""},log:function(a){console.log(a);return a}};function re_escape(a){return a.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")}if(typeof String.prototype.trim!=="function"){String.prototype.trim=function(){return this.replace(/^\s+|\s+$/g,"")}}if(typeof module!=="undefined"&&module.exports){module.exports=Mark}else{if(typeof define==="function"&&define.amd){define(function(){return Mark})}};